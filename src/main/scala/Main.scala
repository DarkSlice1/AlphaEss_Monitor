import com.fasterxml.jackson.module.scala.experimental.ScalaObjectMapper
import com.typesafe.config.{Config, ConfigFactory}
import Api.objectMapper.{getHomeById, token}
import Api.{alpha, reportHome}
import com.fasterxml.jackson.annotation.JsonFormat
import kamon.Kamon
import kamon.system.SystemMetrics

import java.io.File
import scala.io.Source
import scala.util.{Failure, Success, Try}


object Main extends App {

  startKamon(ConfigFactory.load("application.conf"))

  new alpha(){
    //run in a 5min loop

    //val x :String = """{"data":{"homeId":9355,"name":"Home","gatewayId":"1807878140","isOnline":true,"gatewayDateTime":"2019-10-11T23:24:23","lastRefreshed":"2019-10-11T22:24:44.869861Z","users":[{"homeId":9355,"homeName":"Home","userId":17481,"userFullName":"Stephen Walsh","roleId":3,"roleName":"Home Super Admin","roleStaticName":"HOME SUPER ADMIN","accessPermissions":{"homeUserAccessId":14818,"homeUserId":14818,"homeManagement":true,"areaManagement":true,"schedulesManagement":true,"scenarioManagement":true,"eventManagement":true,"holidays":true,"boost":true},"favouriteScenarios":null},{"homeId":9355,"homeName":"Home","userId":17609,"userFullName":"Emma Walsh","roleId":4,"roleName":"Home Admin","roleStaticName":"HOME ADMIN","accessPermissions":{"homeUserAccessId":14819,"homeUserId":14819,"homeManagement":true,"areaManagement":true,"schedulesManagement":true,"scenarioManagement":true,"eventManagement":true,"holidays":true,"boost":true},"favouriteScenarios":null}],"receivers":[{"receiverId":9978,"homeId":9355,"hardwareId":"029F2F97","isOnline":true,"zones":[{"zoneId":25147,"receiverId":9978,"receiverHardwareId":"029F2F97","hardwareId":"0","name":"Hot Water","currentTemperature":30.5,"targetTemperature":50.0,"mode":3,"isHotWater":true,"isOnline":true,"isBoostActive":false,"isAdvanceActive":false,"isDemo":false,"isTargetTemperatureReached":true,"isCurrentlyActive":false,"nextEventDate":null,"boostBaseDate":null,"programme":{"zoneId":25147,"monday":{"dayPeriodId":176024,"period1":{"periodId":528070,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528071,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528072,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"tuesday":{"dayPeriodId":176028,"period1":{"periodId":528082,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528083,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528084,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"wednesday":{"dayPeriodId":176029,"period1":{"periodId":528085,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528086,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528087,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"thursday":{"dayPeriodId":176027,"period1":{"periodId":528079,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528080,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528081,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"friday":{"dayPeriodId":176023,"period1":{"periodId":528067,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528068,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528069,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"saturday":{"dayPeriodId":176025,"period1":{"periodId":528073,"startTime":"07:30:00","endTime":"10:00:00","type":0,"isEnabled":true},"period2":{"periodId":528074,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528075,"startTime":"17:00:00","endTime":"23:00:00","type":0,"isEnabled":true}},"sunday":{"dayPeriodId":176026,"period1":{"periodId":528076,"startTime":"07:30:00","endTime":"10:00:00","type":0,"isEnabled":true},"period2":{"periodId":528077,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528078,"startTime":"17:00:00","endTime":"23:00:00","type":0,"isEnabled":true}}},"areaId":null,"areaName":null,"boostActivations":[{"zoneBoostActivationId":1247650,"zoneId":25147,"zoneName":"Hot Water","userId":17481,"activatedByUserName":"Stephen","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-07T22:42:34.83","finishDateTime":"2019-10-07T23:42:34.83","expiryTime":"2019-10-07T23:42:34.83","wasCancelled":false,"comments":null},{"zoneBoostActivationId":1251646,"zoneId":25147,"zoneName":"Hot Water","userId":17609,"activatedByUserName":"Emma","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-09T11:58:02.57","finishDateTime":"2019-10-09T12:58:02.57","expiryTime":"2019-10-09T12:58:02.57","wasCancelled":false,"comments":null},{"zoneBoostActivationId":1251647,"zoneId":25147,"zoneName":"Hot Water","userId":17609,"activatedByUserName":"Emma","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-09T11:58:06.787","finishDateTime":"2019-10-09T12:58:06.787","expiryTime":"2019-10-09T12:58:06.787","wasCancelled":false,"comments":null},{"zoneBoostActivationId":1251649,"zoneId":25147,"zoneName":"Hot Water","userId":17609,"activatedByUserName":"Emma","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-09T11:58:40.497","finishDateTime":"2019-10-09T12:58:40.497","expiryTime":"2019-10-09T12:58:40.497","wasCancelled":false,"comments":null}]},{"zoneId":25148,"receiverId":9978,"receiverHardwareId":"029F2F97","hardwareId":"1","name":"Downstairs","currentTemperature":20.0,"targetTemperature":23.0,"mode":3,"isHotWater":false,"isOnline":true,"isBoostActive":false,"isAdvanceActive":false,"isDemo":false,"isTargetTemperatureReached":true,"isCurrentlyActive":false,"nextEventDate":null,"boostBaseDate":null,"programme":{"zoneId":25148,"monday":{"dayPeriodId":176031,"period1":{"periodId":528091,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528092,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528093,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"tuesday":{"dayPeriodId":176035,"period1":{"periodId":528103,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528104,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528105,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"wednesday":{"dayPeriodId":176036,"period1":{"periodId":528106,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528107,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528108,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"thursday":{"dayPeriodId":176034,"period1":{"periodId":528100,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528101,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528102,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"friday":{"dayPeriodId":176030,"period1":{"periodId":528088,"startTime":"06:30:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528089,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528090,"startTime":"16:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"saturday":{"dayPeriodId":176032,"period1":{"periodId":528094,"startTime":"07:30:00","endTime":"10:00:00","type":0,"isEnabled":true},"period2":{"periodId":528095,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528096,"startTime":"17:00:00","endTime":"23:00:00","type":0,"isEnabled":true}},"sunday":{"dayPeriodId":176033,"period1":{"periodId":528097,"startTime":"07:30:00","endTime":"10:00:00","type":0,"isEnabled":true},"period2":{"periodId":528098,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528099,"startTime":"17:00:00","endTime":"23:00:00","type":0,"isEnabled":true}}},"areaId":null,"areaName":null,"boostActivations":[]},{"zoneId":25149,"receiverId":9978,"receiverHardwareId":"029F2F97","hardwareId":"2","name":"Upstairs","currentTemperature":19.0,"targetTemperature":22.0,"mode":0,"isHotWater":false,"isOnline":true,"isBoostActive":false,"isAdvanceActive":false,"isDemo":false,"isTargetTemperatureReached":true,"isCurrentlyActive":false,"nextEventDate":"2019-10-12T08:00:00Z","boostBaseDate":null,"programme":{"zoneId":25149,"monday":{"dayPeriodId":176038,"period1":{"periodId":528112,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528113,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528114,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"tuesday":{"dayPeriodId":176042,"period1":{"periodId":528124,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528125,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528126,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"wednesday":{"dayPeriodId":176043,"period1":{"periodId":528127,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528128,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528129,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"thursday":{"dayPeriodId":176041,"period1":{"periodId":528121,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528122,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528123,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"friday":{"dayPeriodId":176037,"period1":{"periodId":528109,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528110,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528111,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"saturday":{"dayPeriodId":176039,"period1":{"periodId":528115,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528116,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528117,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}},"sunday":{"dayPeriodId":176040,"period1":{"periodId":528118,"startTime":"08:00:00","endTime":"08:30:00","type":0,"isEnabled":true},"period2":{"periodId":528119,"startTime":"12:00:00","endTime":"12:00:00","type":0,"isEnabled":true},"period3":{"periodId":528120,"startTime":"22:30:00","endTime":"22:30:00","type":0,"isEnabled":true}}},"areaId":null,"areaName":null,"boostActivations":[]}]}],"holiday":{"homeId":9355,"startDate":null,"endDate":null,"status":0,"scheduledByUserId":17481},"inviteCode":"BE13A","weatherLocation":"Claregalway, IE","weatherLocationId":"2965474","backlightModeIsActive":false,"frostProtectionEnabled":true,"frostProtectionTemperature":5.0,"isFrostProtectionActive":false,"holidayModeActive":false,"activeZoneBoosts":[{"zoneBoostActivationId":1247650,"zoneId":25147,"zoneName":"Hot Water","userId":17481,"activatedByUserName":"Stephen","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-07T22:42:34.83","finishDateTime":"2019-10-07T23:42:34.83","expiryTime":"2019-10-07T23:42:34.83","wasCancelled":false,"comments":null},{"zoneBoostActivationId":1251646,"zoneId":25147,"zoneName":"Hot Water","userId":17609,"activatedByUserName":"Emma","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-09T11:58:02.57","finishDateTime":"2019-10-09T12:58:02.57","expiryTime":"2019-10-09T12:58:02.57","wasCancelled":false,"comments":null},{"zoneBoostActivationId":1251647,"zoneId":25147,"zoneName":"Hot Water","userId":17609,"activatedByUserName":"Emma","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-09T11:58:06.787","finishDateTime":"2019-10-09T12:58:06.787","expiryTime":"2019-10-09T12:58:06.787","wasCancelled":false,"comments":null},{"zoneBoostActivationId":1251649,"zoneId":25147,"zoneName":"Hot Water","userId":17609,"activatedByUserName":"Emma","numberOfHours":1,"targetTemperature":50.0,"activatedOn":"2019-10-09T11:58:40.497","finishDateTime":"2019-10-09T12:58:40.497","expiryTime":"2019-10-09T12:58:40.497","wasCancelled":false,"comments":null}]},"isSuccess":true,"message":null}
   //   |""".stripMargin

    try {
      run()

     // new reportHome().write(jsonMapper.readValue(x, classOf[getHomeById]))
     // println("x");
      Thread.sleep(300)
    }
    catch {
      case ex : Exception => println("ERROR Running - cleaning token, Exception : " + ex.toString);
    }
  }



  private def startKamon(config: Config) = {
    val system = config.getBoolean("kamon.system-metrics.jvm.enabled")
    val host = config.getBoolean("kamon.system-metrics.host.enabled")
    println("Starting Kamon reporters...." + config.getStringList("kamon.reporters").toString)
    Try(Kamon.reconfigure(config)) match {
      case Success(_) =>
        Kamon.loadReportersFromConfig()
        if (system || host) {
          SystemMetrics.startCollecting()
          println(s"Kamon system metrics are enabled[$system], ${if (system) "starting" else "not starting"}.")
          println(s"Kamon host metrics are enabled[$host], ${if (host) "starting" else "not starting"}.")
        }
      case Failure(e) =>
        println("failed", s"Failed to start Kamon with exception ${e.getLocalizedMessage}")
    }
  }
}